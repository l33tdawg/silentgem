# SilentGem v1.5 - Guided Queries & Interactive Exploration

## Overview

Version 1.5 transforms SilentGem from a simple Q&A system into an **intelligent conversation partner** that guides you through information discovery with contextual suggestions and interactive buttons.

## What's New in v1.5

### 1. ğŸ¯ Guided Query Suggestions

After every response, the bot analyzes:
- **What you asked** - Your original question and intent
- **What was found** - Search results and topics discovered
- **Conversation history** - Your previous interests and questions
- **Unexplored areas** - Information mentioned but not detailed

Then generates **3 highly relevant follow-up questions** as clickable buttons.

#### How It Works

The system uses your LLM (Google Gemini or Ollama) to intelligently analyze the conversation:

```python
# The LLM considers:
1. Original query: "What happened with APIs last week?"
2. Results found: 47 messages across 3 channels
3. Topics discovered: REST deprecation, GraphQL migration, Auth changes
4. Previous conversation: User asked about "project status" yesterday
5. What wasn't covered: Specific deadlines, technical details, team reactions

# Generates suggestions like:
â†’ "What are the migration deadlines and timelines?"
â†’ "Show me the technical implementation details for GraphQL"
â†’ "How are different teams reacting to these changes?"
```

### 2. ğŸ“– Expandable Topics

When search results contain substantial topics (â‰¥8 messages), the bot offers "Expand" buttons to deep-dive into specific areas without typing a new query.

**Example:**
- Found 22 messages about "GraphQL migration"
- Button appears: `ğŸ“– Expand: GraphQL Migration (22 messages)`
- Click â†’ Get detailed breakdown just for that topic

### 3. ğŸ”˜ Action Buttons

Quick access to common operations:

- **ğŸ“… Timeline View** - See chronological progression (coming in v1.6)
- **ğŸ‘¥ Contributors** - Identify who's discussing the topic
- **ğŸ’¾ Save Query** - Create reusable templates
- **ğŸ“¤ Export** - Export results (coming soon)

### 4. ğŸ’¾ Query Templates

Save frequently-used queries and run them with one click.

**Use Cases:**
- "Weekly business briefing" - Run every Monday
- "API updates from last 7 days" - Check daily
- "Ukraine news summary" - Monitor ongoing topics

**Management:**
- Create templates with names and descriptions
- Tag templates for easy organization
- Track usage statistics
- Search templates by keyword

## File Changes & Architecture

### New Files Created

1. **`silentgem/bot/guided_queries.py`** (350 lines)
   - `GuidedQueryGenerator` - Main LLM-powered suggestion engine
   - `GuidedQuery`, `ExpandableTopic`, `ActionButton` - Data classes
   - Context analysis and prompt engineering
   - Fallback rule-based generator

2. **`silentgem/bot/query_templates.py`** (280 lines)
   - `QueryTemplateManager` - Save/load/manage templates
   - `QueryTemplate` - Template data structure
   - CRUD operations for templates
   - Template search and usage tracking

3. **`test_guided_queries.py`** (200 lines)
   - End-to-end testing for guided queries
   - Query template testing
   - Mock data for development

### Modified Files

1. **`silentgem/bot/command_handler.py`**
   - Added `handle_query_with_suggestions()` method
   - Integrated guided query generation
   - Added search metadata building
   - Helper methods for date ranges and contributors

2. **`silentgem/bot/telegram_bot.py`**
   - Added `_create_inline_keyboard()` for button rendering
   - Updated message handlers to use guided queries
   - Added callback query handler for button clicks
   - Suggestion storage for callback access
   - Handler for suggest, expand, and action buttons

3. **`data/insights_config.json`**
   - Added v1.5 configuration options:
     ```json
     {
       "enable_guided_queries": true,
       "max_guided_suggestions": 3,
       "enable_expandable_topics": true,
       "enable_action_buttons": true,
       "enable_query_templates": true,
       "guided_query_temperature": 0.7
     }
     ```

4. **`README.md`**
   - Updated roadmap - marked v1.5 as COMPLETED
   - Added comprehensive v1.5 feature documentation
   - Included usage examples with button visualization

## How to Use v1.5 Features

### For Users

1. **Ask a Question:**
   ```
   You: "What happened with APIs last week?"
   ```

2. **Get Response + Buttons:**
   ```
   Bot: Found 47 messages about APIs...
   
   [Buttons appear below]
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ 1ï¸âƒ£ What are the deadlines?         â”‚
   â”‚ 2ï¸âƒ£ Show technical details          â”‚
   â”‚ 3ï¸âƒ£ Who are the contributors?       â”‚
   â”‚ ğŸ“– Expand: GraphQL (22 msgs)       â”‚
   â”‚ [ğŸ“… Timeline] [ğŸ’¾ Save Query]      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```

3. **Tap Any Button:**
   - Suggested questions â†’ Bot processes immediately
   - Expand topics â†’ Get detailed view
   - Action buttons â†’ Execute that action

### Configuration

Enable/disable features in `data/insights_config.json`:

```json
{
  "enable_guided_queries": true,        // Main feature toggle
  "max_guided_suggestions": 3,          // How many suggestions (1-5)
  "enable_expandable_topics": true,     // Show topic expansion buttons
  "enable_action_buttons": true,        // Show action buttons
  "enable_query_templates": true,       // Allow template creation
  "guided_query_temperature": 0.7       // LLM creativity (0.0-1.0)
}
```

### For Developers

#### Generate Guided Queries Programmatically

```python
from silentgem.bot.guided_queries import get_guided_query_generator

generator = get_guided_query_generator()

suggestions = await generator.generate_suggestions(
    query="Your query here",
    search_results=results,
    search_metadata=metadata,
    conversation_history=history,
    response_text=response
)

# Access suggestions
for question in suggestions.follow_up_questions:
    print(f"{question.question} (Category: {question.category})")

for topic in suggestions.expandable_topics:
    print(f"Expand: {topic.label} ({topic.message_count} msgs)")

for button in suggestions.action_buttons:
    print(f"Action: {button.label} [{button.type}]")
```

#### Manage Query Templates

```python
from silentgem.bot.query_templates import get_query_template_manager

manager = get_query_template_manager()

# Create a template
template = manager.create_template(
    name="Weekly Briefing",
    query="What are the main developments from the past 7 days?",
    user_id="user123",
    tags=["weekly", "summary"]
)

# List user's templates
templates = manager.list_templates(user_id="user123")

# Use a template
query = manager.use_template(template.id)
# Now execute the query...
```

## Technical Deep Dive

### Guided Query Generation Pipeline

```
User Query
    â†“
Search & Get Results
    â†“
Build Context Package:
  â€¢ Original query & intent
  â€¢ Search results (topics, channels, contributors)
  â€¢ Conversation history (last 5 exchanges)
  â€¢ Response text
  â€¢ Metadata (dates, counts, etc.)
    â†“
Send to LLM with Specialized Prompt
    â†“
LLM Analyzes:
  â€¢ User's information needs
  â€¢ What was found vs. what was explained
  â€¢ Connections across sources
  â€¢ Logical next questions
    â†“
Generate JSON Response:
  {
    "follow_up_questions": [...],
    "expandable_topics": [...],
    "action_buttons": [...],
    "reasoning": "..."
  }
    â†“
Convert to Telegram Inline Keyboard
    â†“
Display Buttons Below Response
```

### Button Callback Flow

```
User Clicks Button
    â†“
Telegram sends callback_query
    â†“
Extract callback_data (e.g., "suggest:0", "expand:topic_id")
    â†“
Retrieve stored suggestions for this user
    â†“
Execute appropriate action:
  â€¢ suggest:N â†’ Process Nth suggested question
  â€¢ expand:ID â†’ Get detailed info on topic
  â€¢ action:TYPE â†’ Execute action (timeline, save, etc.)
    â†“
Generate new response + new buttons
    â†“
Send to user
```

### Fallback Strategy

If the LLM fails or is unavailable, the system uses **rule-based fallback**:

1. **Follow-up questions:**
   - "Tell me more about [largest topic]"
   - "How do different channels discuss this?"
   - "Who are the main contributors?"

2. **Expandable topics:**
   - Any topic with â‰¥8 messages

3. **Action buttons:**
   - Timeline view (always)
   - Save query (always)

## Performance Considerations

### Caching

Guided query suggestions are generated **after** the response is sent to avoid delaying the user. The workflow:

1. Send response to user (fast - 2-3 seconds)
2. Generate guided queries (async - 3-5 seconds)
3. Add buttons to existing message

This ensures the primary response remains ultra-fast while providing intelligent suggestions.

### LLM Token Usage

- Average tokens per guided query generation: **500-800**
- Uses cached search results (no duplicate searches)
- Temperature: 0.7 (balanced creativity & consistency)

## Future Enhancements

### Planned for v1.6

- **Timeline View** - Chronological visualization
- **Persistent Templates** - Cloud sync across devices
- **Template Marketplace** - Share useful templates
- **Smart Template Suggestions** - AI suggests templates based on usage

### Ideas for Later Versions

- **Multi-modal Buttons** - Images, charts in button popups
- **Conditional Buttons** - Show different buttons based on context
- **Button Analytics** - Track which suggestions users find most useful
- **Voice Responses** - Audio playback of responses

## Troubleshooting

### Buttons Not Appearing

**Check:**
1. `enable_guided_queries: true` in `insights_config.json`
2. LLM is configured (Gemini API key or Ollama running)
3. Search found results (buttons only show with results)

### Buttons Expired Error

- Suggestions expire after session ends
- Ask a new question to get fresh buttons
- This is by design for memory management

### LLM Generation Failed

- Falls back to rule-based suggestions automatically
- Check LLM logs for API errors
- Verify Gemini API key or Ollama connection

## Migration Guide

If upgrading from v1.4 or earlier:

1. **Backup your data:**
   ```bash
   cp -r data/ data-backup/
   ```

2. **Update code:**
   ```bash
   git pull origin main
   ```

3. **Update config:**
   - New fields auto-added with defaults
   - Review `insights_config.json` for customization

4. **Test:**
   ```bash
   python test_guided_queries.py
   ```

5. **Restart bot:**
   ```bash
   python silentgem.py
   ```

## Credits

- **Guided Query Intelligence**: Powered by Google Gemini / Ollama LLMs
- **UI Framework**: Telegram Inline Keyboards (Pyrogram)
- **Inspiration**: ChatGPT's conversation flow, Notion's hover actions

---

**Version**: 1.5.0  
**Release Date**: November 2025  
**Status**: âœ… Production Ready  
**License**: MIT

